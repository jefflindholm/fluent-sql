"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports.default = void 0;require("./string.js");

var _sqlTable = _interopRequireDefault(require("./sql-table"));
var _sqlWhere = _interopRequireDefault(require("./sql-where"));
var _sqlQuery = _interopRequireWildcard(require("./sql-query"));function _interopRequireWildcard(obj) {if (obj && obj.__esModule) {return obj;} else {var newObj = {};if (obj != null) {for (var key in obj) {if (Object.prototype.hasOwnProperty.call(obj, key)) {var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {};if (desc.get || desc.set) {Object.defineProperty(newObj, key, desc);} else {newObj[key] = obj[key];}}}}newObj.default = obj;return newObj;}}function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { default: obj };}function _classCallCheck(instance, Constructor) {if (!(instance instanceof Constructor)) {throw new TypeError("Cannot call a class as a function");}}function _defineProperties(target, props) {for (var i = 0; i < props.length; i++) {var descriptor = props[i];descriptor.enumerable = descriptor.enumerable || false;descriptor.configurable = true;if ("value" in descriptor) descriptor.writable = true;Object.defineProperty(target, descriptor.key, descriptor);}}function _createClass(Constructor, protoProps, staticProps) {if (protoProps) _defineProperties(Constructor.prototype, protoProps);if (staticProps) _defineProperties(Constructor, staticProps);return Constructor;}



function updateDelete(operation, sqlTable, details, encryptFunction) {
  if (!(sqlTable instanceof _sqlTable.default)) {
    throw {
      location: 'SqlBuilder::update',
      message: 'sqlTable is not an instance of SqlTable' };
    // eslint-disable-line
  }
  var options = (0, _sqlQuery.getDefaultOptions)();
  var isArray = !options.namedValues || options.markerType === 'number';
  var data = isArray ? [] : {};
  if (details.id) {
    if (!isArray) {
      data.id = details.id;
    } else {
      data.push(details.id);
    }
  }
  var sep = operation === 'update' ? ',' : ' AND ';
  var hasEncryptedValues = false;
  var item = 1;
  var columns = '';
  var attr;
  var variable;
  var encrypted;
  var column;
  for (attr in details) {// eslint-disable-line no-restricted-syntax
    if (details.hasOwnProperty(attr) && attr !== 'id' && sqlTable.hasOwnProperty(attr)) {
      column = sqlTable[attr];
      if (isArray) {
        variable = (item + 1).toString();
        data.push(details[attr]);
      } else {
        variable = attr + item.toString();
        data[variable] = details[attr];
      }
      encrypted = encryptFunction ? encryptFunction(column, variable) : null;
      variable = encrypted || "".concat(options.namedValueMarker).concat(variable);
      if (encrypted != null) {
        hasEncryptedValues = true;
      }
      columns += "".concat(item === 1 ? '' : sep).concat(attr.toSnakeCase(), " = ").concat(variable);
      item += 1;
    }
  }
  var sql;
  if (operation === 'update') {
    if (isArray) {
      sql = "UPDATE ".concat(sqlTable.getTable(), " SET ").concat(columns, " WHERE id = ").concat(options.namedValueMarker, "1");
    } else {
      sql = "UPDATE ".concat(sqlTable.getTable(), " SET ").concat(columns, " WHERE id = ").concat(options.namedValueMarker, "id");
    }
  } else if (operation === 'delete') {
    if (details.id) {
      if (isArray) {
        columns += "".concat(item === 1 ? '' : sep, "id = ").concat(options.namedValueMarker, "1");
      } else {
        columns += "".concat(item === 1 ? '' : sep, "id = ").concat(options.namedValueMarker, "id");
      }
    }
    sql = "DELETE FROM ".concat(sqlTable.getTable(), " WHERE ").concat(columns);
  } else {
    throw new {
      msg: "Invalid operation ".concat(operation) }();
    //eslint-disable-line
  }
  return {
    sql: sql,
    values: data,
    hasEncrypted: hasEncryptedValues };

}

function buildWhere(filterString, sqlTable) {
  var where = null;
  if (filterString) {
    var ors = filterString.split(';');

    ors.forEach(function (orFilter) {
      var filters = orFilter.split(',');
      var whereClause = null;
      filters.forEach(function (filter) {
        var parts = filter.split('.');
        var attr = parts[0];
        var op = parts[1];
        var val1 = parts[2];
        var val2 = parts.length > 3 ? parts[3] : null;
        if (sqlTable.hasOwnProperty(attr)) {
          var tmpClause = sqlTable[attr].op(op, val1, val2);
          if (whereClause) {
            whereClause = whereClause.and(tmpClause);
          } else {
            whereClause = tmpClause;
          }
        } else {
          throw { location: 'SqlBuilder:buildWhere', message: "unknown column ".concat(attr, " in table ").concat(sqlTable.TableName, " from where clause") };
        }
      });
      if (where) {
        where = where.or(whereClause);
      } else {
        where = whereClause;
      }
    });
  }
  return where;
}var

SqlBuilder = /*#__PURE__*/function () {function SqlBuilder() {_classCallCheck(this, SqlBuilder);}_createClass(SqlBuilder, null, [{ key: "update", value: function update(
    sqlTable, details, encryptFunction) {
      return updateDelete('update', sqlTable, details, encryptFunction);
    } }, { key: "delete", value: function _delete(
    sqlTable, details, encryptFunction) {
      return updateDelete('delete', sqlTable, details, encryptFunction);
    } }, { key: "insert", value: function insert(
    sqlTable, details, newId, encryptFunction) {
      if (!(sqlTable instanceof _sqlTable.default)) {
        throw {
          location: 'SqlBuilder::insert',
          message: 'sqlTable is not an instance of SqlTable' };
        //eslint-disable-line
      }
      var options = (0, _sqlQuery.getDefaultOptions)();
      var isArray = !options.namedValues || options.markerType === 'number';
      var item = 1;
      var data = isArray ? [] : {};
      var variable;
      var encrypted;
      var column;
      var columnList = '';
      var variableList = '';
      var hasEncryptedValues = false;
      for (var attr in details) {// eslint-disable-line no-restricted-syntax
        if (details.hasOwnProperty(attr) && attr !== 'id' && sqlTable.hasOwnProperty(attr)) {
          column = sqlTable[attr];
          if (isArray) {
            variable = item.toString();
            data.push(details[attr]);
          } else {
            variable = attr + item.toString();
            data[variable] = details[attr];
          }
          columnList += (item === 1 ? '' : ',') + attr.toSnakeCase();
          encrypted = encryptFunction ? encryptFunction(column, variable) : null;
          variable = encrypted || "".concat(options.namedValueMarker).concat(variable);
          if (encrypted != null) {
            hasEncryptedValues = true;
          }
          variableList += "".concat(item === 1 ? '' : ',').concat(variable);
          item += 1;
        }
      }
      if (newId) {
        columnList += ', id';
        if (isArray) {
          variableList += ", ".concat(options.namedValueMarker).concat(item);
          data.push(newId);
        } else {
          variableList += ", ".concat(options.namedValueMarker, "id");
          data.id = newId;
        }
      }

      return {
        sql: "INSERT INTO ".concat(sqlTable.getTable(), " (").concat(columnList, ") VALUES (").concat(variableList, ")"),
        values: data,
        hasEncrypted: hasEncryptedValues };

    }
    /*
       * @param {sqlTable} - SqlTable instance for the table to build the update for
       * @param {searchDetails} - object
       *  - select = columns to select from the table (comma separated)
       *  - filter =
       *      = string - where clause column.OP.value,... comma = AND'ed semi-colon = OR'ed
       *          example:
       *                 { select: 'key.gt.9;key.lt.2' } = key > 9 OR key < 2
       *                 { select: 'key.gt.9,name.like.foo;key.lt2 } = (key > 9 AND name like '%foo%') OR (key < 2)
       *      = array of string - column.OP.value... will be OR'ed with each other string
       *  - orderBy = column;[ASC|DESC],...
       *  - pageNo = which page to fetch of paged data defaults to 1st
       *  - pageSize = how much data per page defaults to 50
       */ }, { key: "search", value: function search(

    sqlTable, searchDetails) {
      var query = new _sqlQuery.default();
      query.from(sqlTable);
      var searchColumns = searchDetails.columns || searchDetails.select;
      if (searchColumns) {
        var columns = null;
        if (Array.isArray(searchColumns)) {
          columns = searchColumns;
        } else {
          columns = searchColumns.split(',');
        }
        columns.forEach(function (c) {
          if (sqlTable.hasOwnProperty(c.toCamel())) {
            query.select(sqlTable[c.toCamel()]);
          } else {
            throw { location: 'SqlBuilder:search - columns', message: "(columns) unknown column for table ".concat(sqlTable.TableName, " - ").concat(c) };
          }
        });
      } else {
        query.select(sqlTable.star());
      }

      var whereClause = new _sqlWhere.default();
      if (searchDetails.filter) {
        if (Array.isArray(searchDetails.filter)) {
          searchDetails.filter.forEach(function (filter) {
            whereClause.or(buildWhere(filter, sqlTable));
          });
        } else {
          whereClause = buildWhere(searchDetails.filter, sqlTable);
        }
      }
      if (whereClause) {
        query.where(whereClause);
      }
      if (searchDetails.orderBy) {
        if (Array.isArray(searchDetails.orderBy)) {
          searchDetails.orderBy.forEach(function (c) {
            if (sqlTable.hasOwnProperty(c)) {
              query.orderBy(sqlTable[c]);
            } else {
              throw { location: 'SqlBuilder:Search - orderBy', message: "unknown column for table ".concat(sqlTable.TableName, " - ").concat(c) };
            }
          });
        } else {
          searchDetails.orderBy.split(',').forEach(function (c) {
            var columnDetails = c.split(';');
            var name = columnDetails[0];
            if (sqlTable.hasOwnProperty(name)) {
              query.orderBy(sqlTable[name].dir(columnDetails[1] || 'ASC'));
            } else {
              throw { location: 'SqlBuilder:Search - orderBy2', message: "unknown column for table ".concat(sqlTable.TableName, " - ").concat(c) };
            }
          });
        }
      }
      if (searchDetails.pageNo) {
        query.page(searchDetails.pageNo);
      }
      if (searchDetails.pageSize) {
        query.pageSize(searchDetails.pageSize);
      }
      if (!searchDetails.pageNo && !searchDetails.pageSize) {
        query.pageSize(50);
      }
      return query;
    } }]);return SqlBuilder;}();exports.default = SqlBuilder;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zcWwtYnVpbGRlci5qcyJdLCJuYW1lcyI6WyJ1cGRhdGVEZWxldGUiLCJvcGVyYXRpb24iLCJzcWxUYWJsZSIsImRldGFpbHMiLCJlbmNyeXB0RnVuY3Rpb24iLCJTcWxUYWJsZSIsImxvY2F0aW9uIiwibWVzc2FnZSIsIm9wdGlvbnMiLCJpc0FycmF5IiwibmFtZWRWYWx1ZXMiLCJtYXJrZXJUeXBlIiwiZGF0YSIsImlkIiwicHVzaCIsInNlcCIsImhhc0VuY3J5cHRlZFZhbHVlcyIsIml0ZW0iLCJjb2x1bW5zIiwiYXR0ciIsInZhcmlhYmxlIiwiZW5jcnlwdGVkIiwiY29sdW1uIiwiaGFzT3duUHJvcGVydHkiLCJ0b1N0cmluZyIsIm5hbWVkVmFsdWVNYXJrZXIiLCJ0b1NuYWtlQ2FzZSIsInNxbCIsImdldFRhYmxlIiwibXNnIiwidmFsdWVzIiwiaGFzRW5jcnlwdGVkIiwiYnVpbGRXaGVyZSIsImZpbHRlclN0cmluZyIsIndoZXJlIiwib3JzIiwic3BsaXQiLCJmb3JFYWNoIiwib3JGaWx0ZXIiLCJmaWx0ZXJzIiwid2hlcmVDbGF1c2UiLCJmaWx0ZXIiLCJwYXJ0cyIsIm9wIiwidmFsMSIsInZhbDIiLCJsZW5ndGgiLCJ0bXBDbGF1c2UiLCJhbmQiLCJUYWJsZU5hbWUiLCJvciIsIlNxbEJ1aWxkZXIiLCJuZXdJZCIsImNvbHVtbkxpc3QiLCJ2YXJpYWJsZUxpc3QiLCJzZWFyY2hEZXRhaWxzIiwicXVlcnkiLCJTcWxRdWVyeSIsImZyb20iLCJzZWFyY2hDb2x1bW5zIiwic2VsZWN0IiwiQXJyYXkiLCJjIiwidG9DYW1lbCIsInN0YXIiLCJTcWxXaGVyZSIsIm9yZGVyQnkiLCJjb2x1bW5EZXRhaWxzIiwibmFtZSIsImRpciIsInBhZ2VObyIsInBhZ2UiLCJwYWdlU2l6ZSJdLCJtYXBwaW5ncyI6Im9HQUFBOztBQUVBO0FBQ0E7QUFDQSxnRTs7OztBQUlBLFNBQVNBLFlBQVQsQ0FBc0JDLFNBQXRCLEVBQWlDQyxRQUFqQyxFQUEyQ0Ms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c0Q7QUFDbERoQixRQUFBQSxLQUFLLENBQUNnQixRQUFOLENBQWUsRUFBZjtBQUNIO0FBQ0QsYUFBT2hCLEtBQVA7QUFDSCxLIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICcuL3N0cmluZy5qcyc7XHJcblxyXG5pbXBvcnQgU3FsVGFibGUgZnJvbSAnLi9zcWwtdGFibGUnO1xyXG5pbXBvcnQgU3FsV2hlcmUgZnJvbSAnLi9zcWwtd2hlcmUnO1xyXG5pbXBvcnQgU3FsUXVlcnksIHtcclxuICAgIGdldERlZmF1bHRPcHRpb25zXHJcbn0gZnJvbSAnLi9zcWwtcXVlcnknO1xyXG5cclxuZnVuY3Rpb24gdXBkYXRlRGVsZXRlKG9wZXJhdGlvbiwgc3FsVGFibGUsIGRldGFpbHMsIGVuY3J5cHRGdW5jdGlvbikge1xyXG4gICAgaWYgKCEoc3FsVGFibGUgaW5zdGFuY2VvZiBTcWxUYWJsZSkpIHtcclxuICAgICAgICB0aHJvdyB7XHJcbiAgICAgICAgICAgIGxvY2F0aW9uOiAnU3FsQnVpbGRlcjo6dXBkYXRlJyxcclxuICAgICAgICAgICAgbWVzc2FnZTogJ3NxbFRhYmxlIGlzIG5vdCBhbiBpbnN0YW5jZSBvZiBTcWxUYWJsZSdcclxuICAgICAgICB9OyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lXHJcbiAgICB9XHJcbiAgICBjb25zdCBvcHRpb25zID0gZ2V0RGVmYXVsdE9wdGlvbnMoKTtcclxuICAgIGNvbnN0IGlzQXJyYXkgPSAhb3B0aW9ucy5uYW1lZFZhbHVlcyB8fCBvcHRpb25zLm1hcmtlclR5cGUgPT09ICdudW1iZXInO1xyXG4gICAgY29uc3QgZGF0YSA9IGlzQXJyYXkgPyBbXSA6IHt9O1xyXG4gICAgaWYgKGRldGFpbHMuaWQpIHtcclxuICAgICAgICBpZiAoIWlzQXJyYXkpIHtcclxuICAgICAgICAgICAgZGF0YS5pZCA9IGRldGFpbHMuaWQ7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZGF0YS5wdXNoKGRldGFpbHMuaWQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGNvbnN0IHNlcCA9IG9wZXJhdGlvbiA9PT0gJ3VwZGF0ZScgPyAnLCcgOiAnIEFORCAnO1xyXG4gICAgbGV0IGhhc0VuY3J5cHRlZFZhbHVlcyA9IGZhbHNlO1xyXG4gICAgbGV0IGl0ZW0gPSAxO1xyXG4gICAgbGV0IGNvbHVtbnMgPSAnJztcclxuICAgIGxldCBhdHRyO1xyXG4gICAgbGV0IHZhcmlhYmxlO1xyXG4gICAgbGV0IGVuY3J5cHRlZDtcclxuICAgIGxldCBjb2x1bW47XHJcbiAgICBmb3IgKGF0dHIgaW4gZGV0YWlscykgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXJlc3RyaWN0ZWQtc3ludGF4XHJcbiAgICAgICAgaWYgKGRldGFpbHMuaGFzT3duUHJvcGVydHkoYXR0cikgJiYgYXR0ciAhPT0gJ2lkJyAmJiBzcWxUYWJsZS5oYXNPd25Qcm9wZXJ0eShhdHRyKSkge1xyXG4gICAgICAgICAgICBjb2x1bW4gPSBzcWxUYWJsZVthdHRyXTtcclxuICAgICAgICAgICAgaWYgKGlzQXJyYXkpIHtcclxuICAgICAgICAgICAgICAgIHZhcmlhYmxlID0gKGl0ZW0gKyAxKS50b1N0cmluZygpO1xyXG4gICAgICAgICAgICAgICAgZGF0YS5wdXNoKGRldGFpbHNbYXR0cl0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdmFyaWFibGUgPSBhdHRyICsgaXRlbS50b1N0cmluZygpO1xyXG4gICAgICAgICAgICAgICAgZGF0YVt2YXJpYWJsZV0gPSBkZXRhaWxzW2F0dHJdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVuY3J5cHRlZCA9IChlbmNyeXB0RnVuY3Rpb24gPyBlbmNyeXB0RnVuY3Rpb24oY29sdW1uLCB2YXJpYWJsZSkgOiBudWxsKTtcclxuICAgICAgICAgICAgdmFyaWFibGUgPSBlbmNyeXB0ZWQgfHwgYCR7b3B0aW9ucy5uYW1lZFZhbHVlTWFya2VyfSR7dmFyaWFibGV9YDtcclxuICAgICAgICAgICAgaWYgKGVuY3J5cHRlZCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICBoYXNFbmNyeXB0ZWRWYWx1ZXMgPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbHVtbnMgKz0gYCR7KGl0ZW0gPT09IDEgPyAnJyA6IHNlcCl9JHthdHRyLnRvU25ha2VDYXNlKCl9ID0gJHt2YXJpYWJsZX1gO1xyXG4gICAgICAgICAgICBpdGVtICs9IDE7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgbGV0IHNxbDtcclxuICAgIGlmIChvcGVyYXRpb24gPT09ICd1cGRhdGUnKSB7XHJcbiAgICAgICAgaWYgKGlzQXJyYXkpIHtcclxuICAgICAgICAgICAgc3FsID0gYFVQREFURSAke3NxbFRhYmxlLmdldFRhYmxlKCl9IFNFVCAke2NvbHVtbnN9IFdIRVJFIGlkID0gJHtvcHRpb25zLm5hbWVkVmFsdWVNYXJrZXJ9MWA7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgc3FsID0gYFVQREFURSAke3NxbFRhYmxlLmdldFRhYmxlKCl9IFNFVCAke2NvbHVtbnN9IFdIRVJFIGlkID0gJHtvcHRpb25zLm5hbWVkVmFsdWVNYXJrZXJ9aWRgO1xyXG4gICAgICAgIH1cclxuICAgIH0gZWxzZSBpZiAob3BlcmF0aW9uID09PSAnZGVsZXRlJykge1xyXG4gICAgICAgIGlmIChkZXRhaWxzLmlkKSB7XHJcbiAgICAgICAgICAgIGlmIChpc0FycmF5KSB7XHJcbiAgICAgICAgICAgICAgICBjb2x1bW5zICs9IGAkeyhpdGVtID09PSAxID8gJycgOiBzZXApfWlkID0gJHtvcHRpb25zLm5hbWVkVmFsdWVNYXJrZXJ9MWA7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb2x1bW5zICs9IGAkeyhpdGVtID09PSAxID8gJycgOiBzZXApfWlkID0gJHtvcHRpb25zLm5hbWVkVmFsdWVNYXJrZXJ9aWRgO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHNxbCA9IGBERUxFVEUgRlJPTSAke3NxbFRhYmxlLmdldFRhYmxlKCl9IFdIRVJFICR7Y29sdW1uc31gO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICB0aHJvdyBuZXcge1xyXG4gICAgICAgICAgICBtc2c6IGBJbnZhbGlkIG9wZXJhdGlvbiAke29wZXJhdGlvbn1gXHJcbiAgICAgICAgfTsgLy9lc2xpbnQtZGlzYWJsZS1saW5lXHJcbiAgICB9XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIHNxbCxcclxuICAgICAgICB2YWx1ZXM6IGRhdGEsXHJcbiAgICAgICAgaGFzRW5jcnlwdGVkOiBoYXNFbmNyeXB0ZWRWYWx1ZXMsXHJcbiAgICB9O1xyXG59XHJcblxyXG5mdW5jdGlvbiBidWlsZFdoZXJlKGZpbHRlclN0cmluZywgc3FsVGFibGUpIHtcclxuICAgIGxldCB3aGVyZSA9IG51bGxcclxuICAgIGlmIChmaWx0ZXJTdHJpbmcpIHtcclxuICAgICAgICBjb25zdCBvcnMgPSBmaWx0ZXJTdHJpbmcuc3BsaXQoJzsnKTtcclxuXHJcbiAgICAgICAgb3JzLmZvckVhY2goKG9yRmlsdGVyKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGZpbHRlcnMgPSBvckZpbHRlci5zcGxpdCgnLCcpO1xyXG4gICAgICAgICAgICBsZXQgd2hlcmVDbGF1c2UgPSBudWxsXHJcbiAgICAgICAgICAgIGZpbHRlcnMuZm9yRWFjaCgoZmlsdGVyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJ0cyA9IGZpbHRlci5zcGxpdCgnLicpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYXR0ciA9IHBhcnRzWzBdO1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgb3AgPSBwYXJ0c1sxXTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHZhbDEgPSBwYXJ0c1syXTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHZhbDIgPSBwYXJ0cy5sZW5ndGggPiAzID8gcGFydHNbM10gOiBudWxsO1xyXG4gICAgICAgICAgICAgICAgaWYgKHNxbFRhYmxlLmhhc093blByb3BlcnR5KGF0dHIpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdG1wQ2xhdXNlID0gc3FsVGFibGVbYXR0cl0ub3Aob3AsIHZhbDEsIHZhbDIpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh3aGVyZUNsYXVzZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB3aGVyZUNsYXVzZSA9IHdoZXJlQ2xhdXNlLmFuZCh0bXBDbGF1c2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdoZXJlQ2xhdXNlID0gdG1wQ2xhdXNlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgeyBsb2NhdGlvbjogJ1NxbEJ1aWxkZXI6YnVpbGRXaGVyZScsIG1lc3NhZ2U6IChgdW5rbm93biBjb2x1bW4gJHthdHRyfSBpbiB0YWJsZSAke3NxbFRhYmxlLlRhYmxlTmFtZX0gZnJvbSB3aGVyZSBjbGF1c2VgKSB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBpZiAod2hlcmUpIHtcclxuICAgICAgICAgICAgICAgIHdoZXJlID0gd2hlcmUub3Iod2hlcmVDbGF1c2UpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgd2hlcmUgPSB3aGVyZUNsYXVzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHdoZXJlO1xyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTcWxCdWlsZGVyIHtcclxuICAgIHN0YXRpYyB1cGRhdGUoc3FsVGFibGUsIGRldGFpbHMsIGVuY3J5cHRGdW5jdGlvbikge1xyXG4gICAgICAgIHJldHVybiB1cGRhdGVEZWxldGUoJ3VwZGF0ZScsIHNxbFRhYmxlLCBkZXRhaWxzLCBlbmNyeXB0RnVuY3Rpb24pO1xyXG4gICAgfVxyXG4gICAgc3RhdGljIGRlbGV0ZShzcWxUYWJsZSwgZGV0YWlscywgZW5jcnlwdEZ1bmN0aW9uKSB7XHJcbiAgICAgICAgcmV0dXJuIHVwZGF0ZURlbGV0ZSgnZGVsZXRlJywgc3FsVGFibGUsIGRldGFpbHMsIGVuY3J5cHRGdW5jdGlvbik7XHJcbiAgICB9XHJcbiAgICBzdGF0aWMgaW5zZXJ0KHNxbFRhYmxlLCBkZXRhaWxzLCBuZXdJZCwgZW5jcnlwdEZ1bmN0aW9uKSB7XHJcbiAgICAgICAgICAgIGlmICghKHNxbFRhYmxlIGluc3RhbmNlb2YgU3FsVGFibGUpKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyB7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9jYXRpb246ICdTcWxCdWlsZGVyOjppbnNlcnQnLFxyXG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdzcWxUYWJsZSBpcyBub3QgYW4gaW5zdGFuY2Ugb2YgU3FsVGFibGUnXHJcbiAgICAgICAgICAgICAgICB9OyAvL2VzbGludC1kaXNhYmxlLWxpbmVcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBvcHRpb25zID0gZ2V0RGVmYXVsdE9wdGlvbnMoKTtcclxuICAgICAgICAgICAgY29uc3QgaXNBcnJheSA9ICFvcHRpb25zLm5hbWVkVmFsdWVzIHx8IG9wdGlvbnMubWFya2VyVHlwZSA9PT0gJ251bWJlcic7XHJcbiAgICAgICAgICAgIGxldCBpdGVtID0gMTtcclxuICAgICAgICAgICAgY29uc3QgZGF0YSA9IGlzQXJyYXkgPyBbXSA6IHt9O1xyXG4gICAgICAgICAgICBsZXQgdmFyaWFibGU7XHJcbiAgICAgICAgICAgIGxldCBlbmNyeXB0ZWQ7XHJcbiAgICAgICAgICAgIGxldCBjb2x1bW47XHJcbiAgICAgICAgICAgIGxldCBjb2x1bW5MaXN0ID0gJyc7XHJcbiAgICAgICAgICAgIGxldCB2YXJpYWJsZUxpc3QgPSAnJztcclxuICAgICAgICAgICAgbGV0IGhhc0VuY3J5cHRlZFZhbHVlcyA9IGZhbHNlO1xyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IGF0dHIgaW4gZGV0YWlscykgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXJlc3RyaWN0ZWQtc3ludGF4XHJcbiAgICAgICAgICAgICAgICBpZiAoZGV0YWlscy5oYXNPd25Qcm9wZXJ0eShhdHRyKSAmJiBhdHRyICE9PSAnaWQnICYmIHNxbFRhYmxlLmhhc093blByb3BlcnR5KGF0dHIpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29sdW1uID0gc3FsVGFibGVbYXR0cl07XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyaWFibGUgPSBpdGVtLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHVzaChkZXRhaWxzW2F0dHJdKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXJpYWJsZSA9IGF0dHIgKyBpdGVtLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFbdmFyaWFibGVdID0gZGV0YWlsc1thdHRyXTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgY29sdW1uTGlzdCArPSAoaXRlbSA9PT0gMSA/ICcnIDogJywnKSArIGF0dHIudG9TbmFrZUNhc2UoKTtcclxuICAgICAgICAgICAgICAgICAgICBlbmNyeXB0ZWQgPSAoZW5jcnlwdEZ1bmN0aW9uID8gZW5jcnlwdEZ1bmN0aW9uKGNvbHVtbiwgdmFyaWFibGUpIDogbnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyaWFibGUgPSBlbmNyeXB0ZWQgfHwgYCR7b3B0aW9ucy5uYW1lZFZhbHVlTWFya2VyfSR7dmFyaWFibGV9YDtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZW5jcnlwdGVkICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaGFzRW5jcnlwdGVkVmFsdWVzID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyaWFibGVMaXN0ICs9IGAkeyhpdGVtID09PSAxID8gJycgOiAnLCcpfSR7dmFyaWFibGV9YDtcclxuICAgICAgICAgICAgICAgICAgICBpdGVtICs9IDE7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKG5ld0lkKSB7XHJcbiAgICAgICAgICAgICAgICBjb2x1bW5MaXN0ICs9ICcsIGlkJztcclxuICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyaWFibGVMaXN0ICs9IGAsICR7b3B0aW9ucy5uYW1lZFZhbHVlTWFya2VyfSR7aXRlbX1gO1xyXG4gICAgICAgICAgICAgICAgICAgIGRhdGEucHVzaChuZXdJZCk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhcmlhYmxlTGlzdCArPSBgLCAke29wdGlvbnMubmFtZWRWYWx1ZU1hcmtlcn1pZGA7XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YS5pZCA9IG5ld0lkO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgc3FsOiBgSU5TRVJUIElOVE8gJHtzcWxUYWJsZS5nZXRUYWJsZSgpfSAoJHtjb2x1bW5MaXN0fSkgVkFMVUVTICgke3ZhcmlhYmxlTGlzdH0pYCxcclxuICAgICAgICAgICAgICAgIHZhbHVlczogZGF0YSxcclxuICAgICAgICAgICAgICAgIGhhc0VuY3J5cHRlZDogaGFzRW5jcnlwdGVkVmFsdWVzLFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICAvKlxyXG4gICAgICAgICAqIEBwYXJhbSB7c3FsVGFibGV9IC0gU3FsVGFibGUgaW5zdGFuY2UgZm9yIHRoZSB0YWJsZSB0byBidWlsZCB0aGUgdXBkYXRlIGZvclxyXG4gICAgICAgICAqIEBwYXJhbSB7c2VhcmNoRGV0YWlsc30gLSBvYmplY3RcclxuICAgICAgICAgKiAgLSBzZWxlY3QgPSBjb2x1bW5zIHRvIHNlbGVjdCBmcm9tIHRoZSB0YWJsZSAoY29tbWEgc2VwYXJhdGVkKVxyXG4gICAgICAgICAqICAtIGZpbHRlciA9XHJcbiAgICAgICAgICogICAgICA9IHN0cmluZyAtIHdoZXJlIGNsYXVzZSBjb2x1bW4uT1AudmFsdWUsLi4uIGNvbW1hID0gQU5EJ2VkIHNlbWktY29sb24gPSBPUidlZFxyXG4gICAgICAgICAqICAgICAgICAgIGV4YW1wbGU6XHJcbiAgICAgICAgICogICAgICAgICAgICAgICAgIHsgc2VsZWN0OiAna2V5Lmd0Ljk7a2V5Lmx0LjInIH0gPSBrZXkgPiA5IE9SIGtleSA8IDJcclxuICAgICAgICAgKiAgICAgICAgICAgICAgICAgeyBzZWxlY3Q6ICdrZXkuZ3QuOSxuYW1lLmxpa2UuZm9vO2tleS5sdDIgfSA9IChrZXkgPiA5IEFORCBuYW1lIGxpa2UgJyVmb28lJykgT1IgKGtleSA8IDIpXHJcbiAgICAgICAgICogICAgICA9IGFycmF5IG9mIHN0cmluZyAtIGNvbHVtbi5PUC52YWx1ZS4uLiB3aWxsIGJlIE9SJ2VkIHdpdGggZWFjaCBvdGhlciBzdHJpbmdcclxuICAgICAgICAgKiAgLSBvcmRlckJ5ID0gY29sdW1uO1tBU0N8REVTQ10sLi4uXHJcbiAgICAgICAgICogIC0gcGFnZU5vID0gd2hpY2ggcGFnZSB0byBmZXRjaCBvZiBwYWdlZCBkYXRhIGRlZmF1bHRzIHRvIDFzdFxyXG4gICAgICAgICAqICAtIHBhZ2VTaXplID0gaG93IG11Y2ggZGF0YSBwZXIgcGFnZSBkZWZhdWx0cyB0byA1MFxyXG4gICAgICAgICAqL1xyXG5cclxuICAgIHN0YXRpYyBzZWFyY2goc3FsVGFibGUsIHNlYXJjaERldGFpbHMpIHtcclxuICAgICAgICBjb25zdCBxdWVyeSA9IG5ldyBTcWxRdWVyeSgpO1xyXG4gICAgICAgIHF1ZXJ5LmZyb20oc3FsVGFibGUpO1xyXG4gICAgICAgIGNvbnN0IHNlYXJjaENvbHVtbnMgPSBzZWFyY2hEZXRhaWxzLmNvbHVtbnMgfHwgc2VhcmNoRGV0YWlscy5zZWxlY3Q7XHJcbiAgICAgICAgaWYgKHNlYXJjaENvbHVtbnMpIHtcclxuICAgICAgICAgICAgbGV0IGNvbHVtbnMgPSBudWxsO1xyXG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShzZWFyY2hDb2x1bW5zKSkge1xyXG4gICAgICAgICAgICAgICAgY29sdW1ucyA9IHNlYXJjaENvbHVtbnM7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb2x1bW5zID0gc2VhcmNoQ29sdW1ucy5zcGxpdCgnLCcpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbHVtbnMuZm9yRWFjaCgoYykgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKHNxbFRhYmxlLmhhc093blByb3BlcnR5KGMudG9DYW1lbCgpKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5LnNlbGVjdChzcWxUYWJsZVtjLnRvQ2FtZWwoKV0pO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyB7IGxvY2F0aW9uOiAnU3FsQnVpbGRlcjpzZWFyY2ggLSBjb2x1bW5zJywgbWVzc2FnZTogKGAoY29sdW1ucykgdW5rbm93biBjb2x1bW4gZm9yIHRhYmxlICR7c3FsVGFibGUuVGFibGVOYW1lfSAtICR7Y31gKSB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHF1ZXJ5LnNlbGVjdChzcWxUYWJsZS5zdGFyKCkpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IHdoZXJlQ2xhdXNlID0gbmV3IFNxbFdoZXJlKCk7XHJcbiAgICAgICAgaWYgKHNlYXJjaERldGFpbHMuZmlsdGVyKSB7XHJcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHNlYXJjaERldGFpbHMuZmlsdGVyKSkge1xyXG4gICAgICAgICAgICAgICAgc2VhcmNoRGV0YWlscy5maWx0ZXIuZm9yRWFjaCgoZmlsdGVyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgd2hlcmVDbGF1c2Uub3IoYnVpbGRXaGVyZShmaWx0ZXIsIHNxbFRhYmxlKSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHdoZXJlQ2xhdXNlID0gYnVpbGRXaGVyZShzZWFyY2hEZXRhaWxzLmZpbHRlciwgc3FsVGFibGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh3aGVyZUNsYXVzZSkge1xyXG4gICAgICAgICAgICBxdWVyeS53aGVyZSh3aGVyZUNsYXVzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChzZWFyY2hEZXRhaWxzLm9yZGVyQnkpIHtcclxuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoc2VhcmNoRGV0YWlscy5vcmRlckJ5KSkge1xyXG4gICAgICAgICAgICAgICAgc2VhcmNoRGV0YWlscy5vcmRlckJ5LmZvckVhY2goKGMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoc3FsVGFibGUuaGFzT3duUHJvcGVydHkoYykpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcXVlcnkub3JkZXJCeShzcWxUYWJsZVtjXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgeyBsb2NhdGlvbjogJ1NxbEJ1aWxkZXI6U2VhcmNoIC0gb3JkZXJCeScsIG1lc3NhZ2U6IChgdW5rbm93biBjb2x1bW4gZm9yIHRhYmxlICR7c3FsVGFibGUuVGFibGVOYW1lfSAtICR7Y31gKSB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBzZWFyY2hEZXRhaWxzLm9yZGVyQnkuc3BsaXQoJywnKS5mb3JFYWNoKChjKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29sdW1uRGV0YWlscyA9IGMuc3BsaXQoJzsnKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gY29sdW1uRGV0YWlsc1swXTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoc3FsVGFibGUuaGFzT3duUHJvcGVydHkobmFtZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcXVlcnkub3JkZXJCeShzcWxUYWJsZVtuYW1lXS5kaXIoY29sdW1uRGV0YWlsc1sxXSB8fCAnQVNDJykpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IHsgbG9jYXRpb246ICdTcWxCdWlsZGVyOlNlYXJjaCAtIG9yZGVyQnkyJywgbWVzc2FnZTogKGB1bmtub3duIGNvbHVtbiBmb3IgdGFibGUgJHtzcWxUYWJsZS5UYWJsZU5hbWV9IC0gJHtjfWApIH1cclxuICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChzZWFyY2hEZXRhaWxzLnBhZ2VObykge1xyXG4gICAgICAgICAgICBxdWVyeS5wYWdlKHNlYXJjaERldGFpbHMucGFnZU5vKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHNlYXJjaERldGFpbHMucGFnZVNpemUpIHtcclxuICAgICAgICAgICAgcXVlcnkucGFnZVNpemUoc2VhcmNoRGV0YWlscy5wYWdlU2l6ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghc2VhcmNoRGV0YWlscy5wYWdlTm8gJiYgIXNlYXJjaERldGFpbHMucGFnZVNpemUpIHtcclxuICAgICAgICAgICAgcXVlcnkucGFnZVNpemUoNTApO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcXVlcnlcclxuICAgIH1cclxufVxyXG4iXX0=